---
title: 高可用的监控手段
author:
  name: superhsc
  link: https://github.com/maxpixelton
date: 2021-12-15 22:33:00 +0800
categories: [系统设计]
tags:  [Architecture Design]
math: true
mermaid: true
---

思考一个问题，怎么证明自己负责的系统是高可用的？

因为任何系统架构初衷，最基本诉求是保证系统稳定性和可用性，然后才是基于高流量场景下，保证系统并发承载能力。

## 案例背景

证明系统是如何做到高可用的，涉及一个公认论证：服务等级协议（Service-Level Agreement，SLA）。

SLA 最根本形式是协议双方（服务提供者和用户）签订的一个合约或协议。这个合约规范了双方的商务关系或部分商务关系。简单说，可认为 SLA 是服务可用性一个重要衡量指标。

业界一般用几个 9 的 SLA 服务等级来衡量互联网应用的可用性。比如：

- 京东的可用性是 4 个 9（京东的服务 99.99% 可用），要保证服务在所有运行时间里只有 0.01% 不可用，也就是一年大概有 52.6 分钟不可用，这个 99.99% 就叫作系统的可用性指标。

52.6 分钟可以通过下面公式计算得出：
$$
SLA = (1 - \frac{年度不可用时间}{年度总时间}) \times 100 \%
$$
从公式中可以看出， SLA 等于 4 个 9，也就是可用时长达到了 99.99% ，不可用时长则为是 0.01%，一年是 365 天， 8760 个小时，一年的不可用时长就是 52.6 分钟，那么：

- SLA 等于 3 个 9，就相当于一年不可用时长等于 526 分钟；
- SLA 等于 5 个 9，就相当于一年不可用时长等于 5.26 分钟。

可以发现，用 SLA 等于 4 个 9 作为参照物，少个 9 相当于小数点往后移一位，多个 9 相当于小数点往前移一位，如下表：

| 系统可用性（%）    | 宕机时间（年） | 宕机时间（月） | 宕机时间（周） | 宕机时间（天） |
| :----------------- | :------------- | -------------- | -------------- | -------------- |
| 90% （1 个 9）     | 36.5 天        | 72 小时        | 16.8 小时      | 2.4 小时       |
| 99% （2 个 9）     | 3.65 天        | 7.2 小时       | 1.68 小时      | 14.4 分钟      |
| 99.9% （3 个 9）   | 8.76 分钟      | 43.8 分钟      | 10.1 分钟      | 1.44 分钟      |
| 99.99% （4 个 9）  | 52.66 小时     | 4.38 分钟      | 1.01 分钟      | 8.66 秒        |
| 99.999% （5 个 9） | 5.26 分钟      | 25.9 秒        | 6.05 秒        | 0.87 秒        |

**问题就来了：** 既然 SLA 是服务可用性的一个衡量指标，怎么设置这个指标的阈值才合理呢？

一般来讲：

- 2 个 9 ，系统基本可用，年度不可用时间小于 88 小时。
- 3 个 9 ，较高可用，年度不可用时间小于 9 个小时。
- 4 个 9 ，具有自动恢复能力的高可用，年度不可用时间小于 53 分钟。
- 5 个 9 ，极高可用性，年度不可用时间小于 5 分钟。

在电商平台中（比如淘宝、京东、拼多多），系统可用性大多是 4 个 9。那



## 案例分析

要知道，任何一家互联网公司，都有流量低峰期和高峰期，在低峰期停机 1 分钟和高峰期停机 1 分钟，对业务影响的结果完全不同。

所以，仅凭理论指标在有些情况下是不能满足实际需求，更加科学的度量方式就是基于一段时间（比如 1 年）的停机影响的请求量占比，进行评估，公式如下：
$$
高可用评估 = \frac{停机时间影响请求量}{总的请求量} \times 100 \%
$$
这样一来，就可以评估业务在高峰期停机和在低峰期停机分别造成多少的损失了。**所以，如果再指定系统高可用指标时，可以遵循这样的套路：先摆明度量的两种方式，“N 个 9” 和 “影响请求量占比”，然后结合实际业务场景表明第二种方式的科学性。**

总的来说，要立足业务价值去回答问题，不能仅停留于技术概念堆砌。

除此之外，还要有个思路闭环。**这个思路总结为：“可评估”“可监控”“可保证”。**

所以，要了解系统高可用时，其实是在回答这样几个问题：

- 如何评估系统高可用？
- 如何监控系统高可用？
- 如何保证系统高可用？

## 案例方案

以设计一个保证系统服务 SLA 等于 4 个 9 的监控报警体系为例。

监控系统包括三个部分：

1. 基础设施监控报警；
2. 系统应用监控报警；
3. 存储服务监控报警。

接下来，围绕这三个最核心框架设计一个监控系统，并基于监控系统的设计，了解到系统哪些环节会影响系统整体的可用性，从而对系统高可用设计有更加清晰的掌握。

### 基础设施监控

基础设施监控由三个部分组成：

1. 监控报警指标

   **监控报警指标分为两种类型：**

   - 系统要素指标：主要有 CPU、内存，和磁盘；

   - 网络要素指标：主要有带宽、网络 I/O、CDN、DNS、安全策略、和负载策略。

   为什么要监控这些指标？因为它们是判断系统基础环境是否为高可用的重要核心指标。

   ![监控报警指标](https://maxpixelton.github.io/images/assert/architecute/1501.png)

2. 监控工具

   常用的有：

   - ZABBIX（Alexei Vladishev 开源的监控系统，覆盖市场最多的老牌监控系统，资料很多）；
   - Open-Falcon（小米开源的监控系统，小米、滴滴、美团等公司内部都在用）；
   - Prometheus（SoundCloud 开源监控系统，对 K8S 的监控支持更好）。

   这些工具基本都能监控所有系统 CPU、内存、磁盘、网络带宽、网络 I/O 等基础关键指标，再结合一些运营商提供的监控平台，就可以覆盖整个基础设施监控。

3. 报警策略

   **监控报警策略一般由时间维度**、**报警级别**、**阈值设定三部分组成**。

   ![监控报警策略](https://maxpixelton.github.io/images/assert/architecute/1502.png)

   假设系统的监控指标有CPU、内存和磁盘，监控的时间维度是分钟级，监控的阈值设置为占比。那么你可以定义出如下的监控报警策略：

   | 监控指标 | 时间粒度 | 紧急 | 重要 | 一般 |
   | -------- | -------- | ---- | ---- | ---- |
   | CPU      | 分钟     | 90%  | 80%  | 70%  |
   | 内存     | 分钟     | 90%  | 80%  | 70%  |
   | 磁盘     | 分钟     | 90%  | 80%  | 70%  |

   为了第一时间监测到指标的健康度，报警级别可以分为紧急、重要，以及一般。当 CPU、内存，以及磁盘使用率这三项指标每分钟采集指标达到 90% 使用率时，就触发“紧急报警”；达到 80% 触发“重要报警”；70% 触发“一般报警”。

### 系统应用监控

业务状态监控报警，关注点在于**系统自身状态的监控报警**。

和基础设施监控一样，它也是由监控指标，监控工具，报警策略组成。

不同的是，系统应用监控报警的核心监控指标主要有流量、耗时、错误、心跳、客户端数、连接数等 6 个核心指标。

监控工具有 CAT、SkyWalking、Pinpoint、Zipkin 等。

![1504](https://maxpixelton.github.io/images/assert/architecute/1504.png)

### 存储服务监控

常用的第三方存储有：

- DB；
- ES；
- Redis；
- MQ 等。

对于存储服务的监控，除了基础指标监控之外，还有像**集群节点**、**分片信息**、**存储数据**信息等相关特有存储指标的监控。

为了确保系统的健康可靠，设计一套监控体系，用于在生产环境对系统可用性进行监控，具体指标细节可以结合业务场景进行裁剪，比如游戏领域，很关注流量和客户端连接数。总的来说，**有一个全局的监控视角，比掌握很多监控指标更为重要。**

很多互联网公司都很重视系统服务稳定性的工作，因为服务的稳定性直接影响用户的体验和口碑，线上服务稳定性是研发工程师必须要重点关注的问题。如果线上出现告警和故障，作为核心研发，要有应急响应机制，我总结以下几点：

 <table>
   <tr>
    <td colspan="4" style="text-align:center">故障处理原则</td>
   </tr>
   <tr>
    <td></td>
    <td>线上故障发生前</td>
    <td>线上故障发生时</td>
    <td>线上故障发生后</td>
   </tr>
   <tr>
    <td>应急响应的目标</td>
    <td>积极预防，尽可能避免或减少故障发生。</td>
    <td>以快速恢复服务为第一优先级，避免或减少故障带来的损失和对客户的影响。</td>
    <td>及时总结经验教训，提高整个团队的应急水平。</td>
   </tr>
   <tr>
    <td>应急响应的原则</td>
    <td>如果不能短时间解决问题，应及时升级处理，尽可能止损。</td>
    <td>在第一时间恢复服务（首要原则）</td>
    <td>影响重大（比如受影响用户范围大，受损资金多，关键功能受阻等)，应立即升级处理。</td>
   </tr>
   <tr>
    <td>应急响应流程</td>
    <td colspan="3">事前预防、问题监控、事中应对、故障定位、故障解决、事后总结、故障回顾、改进措施</td>
   </tr>
  </table>



## 总结

![1506](https://maxpixelton.github.io/images/assert/architecute/1506.png)
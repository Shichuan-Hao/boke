---
title: Presto 架构
date: 2023-05-11 14:31:57 +0800
categories: [博客]
tags: [presto] 
---


- 查询执行模型
- 查询计划
- 基于代价的查询优化算法
### 集群中的协调器和工作节点
Presto 是一个分布式 SQL 查询引擎，**类似**于**大规模并行处理（massively parallel processing，MPP）**数据库。Presto 并非通过提高单台服务器性能来进行横向扩展，而是通过在整个集群的服务器上分配处理任务来实现横向扩展，这也就是说，您可以通过添加更多的计算节点来获得更强大的处理能力。

基于这种架构，Presto 的查询引擎可以在集群内的计算节点上并行处理海量数据上的 SQL 查询。在每个计算节点上，Presto 都以单个服务端进程的形式运行。一个 Presto 集群由多个被配置为相互协作的 Presto 节点所组成。

a  images(https://cdn.nlark.com/yuque/0/2023/jpeg/35987817/1692172306331-4ee215dc-d1a0-477e-a76b-3eb44b159767.jpeg)
上图是一个具有单个协调器和多个工作节点的 Presto 集群的概览。用户使用客户端程序（如使用 JDBC 驱动的工具或 Presto CLI）连接到集群中的协调器。协调器之后协调工作节点访问数据源。

- **协调器**：主要接受用户查询，管理**工作节点，**以执行查询工作
- **工作节点**：负责执行任务和处理数据

协调器上通常会运行**一个节点发现服务（point discovery service）**，工作节点通过注册到此服务来加入集群。
**客户端、协调器和工作节点之间的通信和数据传输完全通过基于 HTTP/HTTPS 的 RESTful API 调用。**

下图展示了集群里协调器和工作节点（以及工作节点之间）是如何通信的。协调器为工作节点分配任务、更新状态并从工作节点获取顶层的结果集返回给用户。工作节点从数据源以及运行在其他节点上的上游任务中获取数据。
a  images(https://cdn.nlark.com/yuque/0/2023/jpeg/35987817/1692173053859-aa6c38d7-8e22-41c3-b049-030df767b7fb.jpeg)
### 协调器
Presto 协调器的功能是：

- 接收用户 SQL 查询
- 解析查询语句
- 规划查询执行
- 管理工作节点

协调器是 Presto 集群的大脑，所有客户端应用程序都会连接它。用户可以通过 Presto CLI 、使用 JDBC 或 ODBC 驱动的应用程序以及其他语言下可用的客户端库来与协调器交互。协调器接收客户端发送来的 SQL 语句（如 SELECT 查询）并执行。

一个 Presto 集群至少包含一个协调器，可能包含一个或多个工作节点。在开发和测试场景下，单个 Presto 实例可以同时承担协调器和工作节点的职责。

协调器会跟踪每个工作节点的动态，并协调查询任务的执行。对于一条查询，协调器将创建一个包含多个 Stage（阶段）的逻辑模型。

下图展示了客户端、协调器和工作节点之间的通信：
a  images(https://cdn.nlark.com/yuque/0/2023/jpeg/35987817/1692261344473-8ca6e7d7-56b1-45c8-b617-7e84f29f6215.jpeg)
流程如下：

1. 当协调器接收到一条 SQL 语句，就负责解析、分析、优化和调度查询任务在 Presto 工作节点上执行
2. 查询语句（SQL语句）被翻译成一系列相连的任务（Task），这些任务被分发到各个工作节点上执行
3. 在工作节点处理数据的同时，协调器会将结果抽取出来放到输出缓冲区，并将缓冲区的内容暴露给客户端
4. 当客户端读完输出缓冲区的内容，协调器就会代表客户端向工作节点请求更多的数据此外，工作节点也在不断地与数据源交互并从中读取数据
5. 循环往复，客户端不断地请求数据，工作节点则不断地从数据源读取数据并提供给客户端，直到查询执行结束
### 节点发现服务
Presto 使用**节点发现服务**来发现集群中的所有节点。
每个 Presto 实例在启动时都会注册到**节点发现服务**，并定期发送心跳信号。这样一来，协调器就能够维护一个可用工作节点的最新列表，并用它来调度查询执行。
当**节点发现服务**无法接收到一个工作节点的心跳信号时，**节点发现服务**就会触发错误检测器，此后该工作节点不会再参与新的任务。
为简化部署，同时避免运行额外服务，Presto 协调器通常会运行一个内嵌版的**节点发现服务**。因为它与 Presto 共享一个 HTTP 服务端，所以使用同一个端口。
因此，工作节点通常将**节点发现服务**的配置指向协调器的主机名和端口。
### 工作节点
工作节点是 Presto 集群中的一个服务端程序，它主要负责执行协调器分配的任务并处理数据。工作节点使用连接器从数据源获取数据，它们相互之间也会交换中间数据。它们将最终的结果数据发送给协调器，由协调器负责收集来自各个工作节点的结果并发送给客户端。

在安装时，工作节点需要知道集群的节点发现服务所在的主机名或 IP 地址。工作节点会在启动时将自己注册到节点发现服务上，以便协调器向其分配任务。

工作节点使用 HTTP 与其他工作节点和协调器通信。

下图展示了多个工作节点如何从数据源获取数据并合作处理数据，直到其中一个节点可以向协调器发送结果。
a  images(https://cdn.nlark.com/yuque/0/2023/jpeg/35987817/1692350145869-c69db563-c4cb-4893-bec7-6bebe7bcbb8f.jpeg)
### 基于连接器的架构
Presto 存储与计算分离的核心是基于连接器的架构，**连接器**为 Presto 提供了连接任意数据源的接口。

每个连接器在底层数据源上提供了一个基于表的抽象。只要数据可以用 Presto 支持的数据类型表示成表、列和行，就可以创建连接器，并让查询引擎使用这些数据进行查询处理。

Presto 提供了**服务提供者接口（service provider interface, SPI）**—— 用来实现连接器的 API。通过在连接器中实现 SPI，Presto 就可以在内部使用标准操作来连接到任意数据源并执行操作。连接器负责处理与特定数据源相关的细节。

连接器实现 API 的三个部分：

- 获取表、视图、schema 元数据的操作；
- 产生数据分区的逻辑单位的操作，用于 Presto 的并行读写
- 在源数据和查询引擎所需的内存数据格式之间进行转换的数据读取和写入组件。

Presto 提供了许多系统的连接器，如 HDFS/Hive、MySQL、PostgreSQL、MS SQL Server、Kafka、Cassandra、Redis 等。可用的连接器还在持续增加，从 Presto 文档获知最新的....当您需要连接到一个尚为支持的数据源时，可以利用 Presto 的 SPI 创建自定义的连接器。

下图展示了 Presto SPI 包含的不同接口，其中协调器使用的是元数据、数据统计和数据定位接口，工作节点使用的是数据流接口
![Presto SPI 概览](https://cdn.nlark.com/yuque/0/2023/png/35987817/1692578925550-ed250d68-7eeb-4e91-9c52-22c2083e5180.png#averageHue=%234b4c4b&clientId=u2d39a7ac-2930-4&from=paste&height=345&id=ua68886a6&originHeight=345&originWidth=1504&originalType=binary&ratio=1&rotation=0&showTitle=true&size=94026&status=done&style=none&taskId=ub00c6d2e-1bd6-415d-a859-c0caf794358&title=Presto%20SPI%20%E6%A6%82%E8%A7%88&width=1504 "Presto SPI 概览")Presto 服务端程序在启动时，以插件的形式加载连接器。连接器由 catalog 属性文件中特定的参数配置，并从插件目录中加载。
> Presto 的很多功能使用了基于插件的架构。除了连接器、插件也可以提供事件监听器、访问控制以及函数和数据类型

### catalog、schema 和 表
Presto集群使用前文所述的基于连接器的架构处理所有查询。每个 catalog 都会配置一个连接器来访问特定的数据源。数据源在 catalog 中暴露出一个或多个 schema，每个 schema 又包含表。表提供数据行，每个数据行由一些具有不同数据类型的列组成。

### 查询执行模型
想一下，终端用户通过 CLI、使用 ODBC 或 JDBC 的客户端或其他客户端发送 SQL 语句到协调器、协调器之后调用工作节点从数据源获得数据、创建结果数据集并将结果返回给客户端。
#### 查询计划
首先仔细了解下协调器内部的情况。SQL 语句首先以文本形式提交到协调器，协调器解析和分析这条语句，之后创建一个由 Presto 内部数据结构表示的执行计划，叫做**查询计划（全面地表示了一条 SQL 语句处理数据和返回结果所需进行的步骤）**。如下图：
a  images(https://cdn.nlark.com/yuque/0/2023/jpeg/35987817/1692580664792-8e08f0a3-6e00-42cd-b3bf-914b5debef3c.jpeg)

再如下图，查询计划生成过程是利用了元数据 SPI 和数据统计 SPI 来创建查询计划。也就是说，协调器会使用 SPI 直接连接到数据源，以收集有关表和其他元数据的信息。
a  images(https://cdn.nlark.com/yuque/0/2023/jpeg/35987817/1692581393312-767f5145-8bb6-49e4-8813-33f4769b5bef.jpeg)

- 协调器通过元数据 SPI 获取表、列和数据类型的信息，这些信息用于对查询进行语义校验、类型检查和安全检查和安全检查
- 协调器通过统计 SPI 用于获取行数和表大小的信息，从而在计划期间进行基于代价的查询优化
- 协调器在创建**分布式查询计划**时，利用数据位置 SPI 来生成表内容的逻辑切片。切片是任务分配和并行的最小单位
> 这里对不同类型 SPI 的划分是概念上的，实际的底层 Java API 以更细粒度的形式划分为多个 Java 包

#### 分布式查询计划
分布式查询计划是简单查询计划的一个扩展，它包含一个或多个  Stage。简单查询计划被切分为多**个计划片段（plan fragment）**。**Stage** 是在运行时的计划片段，它包含对应计划片段所描述的所以任务。

协调器将查询计划切分成 Stage，从而分配给集群中的多个工作节点进行并行处理，从而加快整体查询的执行速度。多个 Stage 会被组织成一颗依赖树。
Stage 的数量依赖于查询的复杂度。例如，查询的表、返回的列、JOIN 语句、WHERE 条件、GROUP BY 操作和其他 SQL 语句都可能影响 Stage 的数量。

下图展示了集群中的协调器如何将**逻辑查询计划**转换为**分布式查询计划**：
